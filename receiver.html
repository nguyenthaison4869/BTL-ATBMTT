<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nh·∫≠n Email C√≥ Gi·ªõi H·∫°n Th·ªùi Gian</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f4f4f4;
        }
        h1, h3 {
            color: #333;
        }
        .section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        button {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        input[type="text"] {
            padding: 8px;
            width: 300px;
            margin: 10px 0;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f0f0f0;
        }
        #logContainer {
            height: 200px;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 10px;
            background-color: #f9f9f9;
        }
    </style>
</head>
<body>
    <h1>üîê Nh·∫≠n Email C√≥ Gi·ªõi H·∫°n Th·ªùi Gian</h1>
    
    <div class="section" id="status">
        <h3>Tr·∫°ng th√°i h·ªá th·ªëng:</h3>
        <div id="realTimeStatus">ƒêang kh·ªüi t·∫°o...</div>
    </div>
    
    <div class="section" id="availableFiles">
        <h3>File c√≥ s·∫µn:</h3>
        <button id="refreshBtn">L√†m m·ªõi danh s√°ch</button>
        <div id="filesList"></div>
    </div>
    
    <div class="section" id="receiveSection">
        <h3>Nh·∫≠n File</h3>
        <form id="receiveForm">
            <div>
                <label for="fileIdInput">Nh·∫≠p File ID:</label><br>
                <input type="text" id="fileIdInput" placeholder="D√°n File ID t·ª´ ng∆∞·ªùi g·ª≠i" required>
            </div>
            <button type="submit" id="receiveBtn">Nh·∫≠n File</button>
        </form>
        <div id="receiveResult"></div>
    </div>
    
    <div class="section" id="logSection">
        <h3>Log th·ªùi gian th·ª±c:</h3>
        <div id="logContainer"></div>
    </div>

    <script>
        const API_URL = 'http://localhost:3000';

        // H√†m log th·ªùi gian th·ª±c
        function addLog(message) {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleString('vi-VN');
            logContainer.innerHTML += `<div><strong>[${timestamp}]</strong> ${message}</div>`;
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // C·∫≠p nh·∫≠t tr·∫°ng th√°i th·ªùi gian th·ª±c
        function updateStatus(status) {
            document.getElementById('realTimeStatus').textContent = status;
            addLog(`Tr·∫°ng th√°i: ${status}`);
        }

        // ƒê·ªãnh d·∫°ng th·ªùi gian c√≤n l·∫°i
        function formatTimeLeft(seconds) {
            if (seconds <= 0) return 'ƒê√£ h·∫øt h·∫°n';
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            return `${hours}h ${minutes}m ${secs}s`;
        }

        // T·∫£i danh s√°ch file c√≥ s·∫µn
        async function loadAvailableFiles() {
            try {
                updateStatus('ƒêang t·∫£i danh s√°ch file...');
                const response = await fetch(`${API_URL}/api/available-files`);
                if (!response.ok) throw new Error(`HTTP ${response.status}: L·ªói t·∫£i danh s√°ch file`);
                
                const files = await response.json();
                const filesList = document.getElementById('filesList');
                
                if (files.length === 0) {
                    filesList.innerHTML = '<p style="color: #666;">Kh√¥ng c√≥ file n√†o kh·∫£ d·ª•ng</p>';
                    updateStatus('Kh√¥ng c√≥ file n√†o ƒë·ªÉ nh·∫≠n');
                } else {
                    let html = '<table><tr><th>File ID</th><th>T√™n file</th><th>H·∫øt h·∫°n</th><th>Th·ªùi gian c√≤n l·∫°i</th><th>H√†nh ƒë·ªông</th></tr>';
                    files.forEach(file => {
                        const timeLeft = formatTimeLeft(file.timeLeft);
                        const expirationDate = new Date(file.expiration).toLocaleString('vi-VN');
                        const isExpired = file.timeLeft <= 0;
                        html += `
                            <tr style="${isExpired ? 'background-color: #ffcccc;' : ''}">
                                <td style="font-family: monospace; font-size: 12px;">${file.fileId}</td>
                                <td>${file.filename}</td>
                                <td>${expirationDate}</td>
                                <td style="color: ${isExpired ? 'red' : 'green'};">${timeLeft}</td>
                                <td>
                                    <button onclick="quickReceive('${file.fileId}')" 
                                            ${isExpired ? 'disabled' : ''}>
                                        ${isExpired ? 'ƒê√£ h·∫øt h·∫°n' : 'Nh·∫≠n ngay'}
                                    </button>
                                </td>
                            </tr>
                        `;
                    });
                    html += '</table>';
                    filesList.innerHTML = html;
                    updateStatus(`T√¨m th·∫•y ${files.length} file`);
                }
                
                addLog(`ƒê√£ t·∫£i ${files.length} file t·ª´ server`);
            } catch (error) {
                document.getElementById('filesList').innerHTML = `<p style="color: red;">L·ªói t·∫£i danh s√°ch: ${error.message}</p>`;
                updateStatus('L·ªói t·∫£i danh s√°ch file');
                addLog(`L·ªói t·∫£i danh s√°ch: ${error.message}`);
            }
        }

        // Nh·∫≠n file nhanh t·ª´ b·∫£ng
        window.quickReceive = async function(fileId) {
            document.getElementById('fileIdInput').value = fileId;
            await receiveFile(fileId);
        };

        // Nh·∫≠n file
        async function receiveFile(fileId) {
            try {
                const receiveBtn = document.getElementById('receiveBtn');
                receiveBtn.disabled = true;
                updateStatus('ƒêang x√°c th·ª±c v√† nh·∫≠n file...');
                addLog(`B·∫Øt ƒë·∫ßu nh·∫≠n file: ${fileId}`);
                
                const response = await fetch(`${API_URL}/api/receive-file`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ fileId })
                });

                const data = await response.json();

                if (response.ok) {
                    document.getElementById('receiveResult').innerHTML = `
                        <div style="color: green; border: 2px solid green; padding: 15px; margin: 10px 0;">
                            <h4>‚úì ${data.message}</h4>
                            <p><strong>T√™n file:</strong> ${data.filename}</p>
                            <p><strong>ƒê√£ l∆∞u t·∫°i:</strong> ${data.savedPath}</p>
                            <p><strong>Th·ªùi gian nh·∫≠n:</strong> ${new Date().toLocaleString('vi-VN')}</p>
                        </div>
                    `;
                    updateStatus('File ƒë√£ ƒë∆∞·ª£c nh·∫≠n v√† gi·∫£i m√£ th√†nh c√¥ng');
                    addLog(`ACK - File ${data.filename} ƒë√£ ƒë∆∞·ª£c nh·∫≠n th√†nh c√¥ng`);
                    addLog(`File ƒë√£ l∆∞u t·∫°i: ${data.savedPath}`);
                    setTimeout(loadAvailableFiles, 1000); // L√†m m·ªõi danh s√°ch
                } else {
                    let errorMessage = '';
                    let errorColor = 'red';
                    switch (data.error) {
                        case 'TIMEOUT':
                            errorMessage = `‚è∞ ${data.message}`;
                            break;
                        case 'INTEGRITY':
                            errorMessage = `üõ°Ô∏è ${data.message}`;
                            break;
                        case 'SIGNATURE':
                            errorMessage = `üîê ${data.message}`;
                            break;
                        case 'NACK':
                            errorMessage = `‚ùå ${data.message}`;
                            break;
                        default:
                            errorMessage = `‚ùå ${data.error}: ${data.message}`;
                    }
                    document.getElementById('receiveResult').innerHTML = `
                        <div style="color: ${errorColor}; border: 2px solid ${errorColor}; padding: 15px; margin: 10px 0;">
                            <h4>${errorMessage}</h4>
                            <p><strong>File ID:</strong> ${fileId}</p>
                            <p><strong>Th·ªùi gian th·ª≠:</strong> ${new Date().toLocaleString('vi-VN')}</p>
                        </div>
                    `;
                    updateStatus(`Nh·∫≠n file th·∫•t b·∫°i: ${data.error}`);
                    addLog(`NACK - L·ªói nh·∫≠n file: ${errorMessage}`);
                }
            } catch (error) {
                document.getElementById('receiveResult').innerHTML = `
                    <div style="color: red; border: 2px solid red; padding: 15px; margin: 10px 0;">
                        <h4>‚ùå L·ªói k·∫øt n·ªëi server</h4>
                        <p>${error.message}</p>
                    </div>
                `;
                updateStatus('L·ªói k·∫øt n·ªëi server');
                addLog(`L·ªói k·∫øt n·ªëi: ${error.message}`);
            } finally {
                document.getElementById('receiveBtn').disabled = false;
            }
        }

        // Form submit
        document.getElementById('receiveForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const fileId = document.getElementById('fileIdInput').value.trim();
            if (!fileId) {
                alert('Vui l√≤ng nh·∫≠p File ID!');
                return;
            }
            await receiveFile(fileId);
        });

        // Refresh button
        document.getElementById('refreshBtn').addEventListener('click', loadAvailableFiles);

        // T·ª± ƒë·ªông c·∫≠p nh·∫≠t danh s√°ch m·ªói 5 gi√¢y
        setInterval(loadAvailableFiles, 5000);

        // Kh·ªüi t·∫°o
        updateStatus('H·ªá th·ªëng s·∫µn s√†ng - ƒêang t·∫£i danh s√°ch file...');
        addLog('Trang nh·∫≠n file ƒë√£ ƒë∆∞·ª£c t·∫£i');
        loadAvailableFiles();
    </script>
</body>
</html>