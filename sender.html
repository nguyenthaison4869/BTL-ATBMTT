<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G·ª≠i Email C√≥ Gi·ªõi H·∫°n Th·ªùi Gian</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f4f4f4;
        }
        h1 {
            color: #333;
        }
        .section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        button {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        input[type="file"], input[type="number"] {
            margin: 10px 0;
        }
        #log {
            background: #f8f8f8;
            padding: 10px;
            height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <h1>üîê G·ª≠i Email C√≥ Gi·ªõi H·∫°n Th·ªùi Gian</h1>

    <div class="section">
        <h2>Tr·∫°ng th√°i h·ªá th·ªëng:</h2>
        <p id="status">ƒêang kh·ªüi t·∫°o...</p>
    </div>

    <div class="section">
        <h2>1. B·∫Øt tay</h2>
        <button id="handshakeBtn" onclick="startHandshake()">B·∫Øt ƒë·∫ßu Handshake</button>
    </div>

    <div class="section">
        <h2>2. G·ª≠i File</h2>
        <form id="uploadForm">
            <label for="fileInput">Ch·ªçn file vƒÉn b·∫£n (.txt):</label><br>
            <input type="file" id="fileInput" accept=".txt" required><br>
            <label for="expirationInput">Th·ªùi gian h·∫øt h·∫°n (gi·ªù):</label><br>
            <input type="number" id="expirationInput" min="1" value="24" required>
            <p>M·∫∑c ƒë·ªãnh: 24 gi·ªù</p>
            <button type="submit" id="uploadBtn" disabled>M√£ h√≥a v√† G·ª≠i File</button>
        </form>
    </div>

    <div class="section">
        <h2>Log th·ªùi gian th·ª±c:</h2>
        <div id="log"></div>
    </div>

    <script>
        const API_URL = 'http://localhost:3000';
        let sessionId = null;
        let publicKey = null;

        // Log function
        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toISOString();
            logDiv.innerHTML += `[${timestamp}] ${message}<br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // Update status
        function updateStatus(message) {
            document.getElementById('status').textContent = message;
        }

        // Start handshake
        async function startHandshake() {
            try {
                log('B·∫Øt ƒë·∫ßu qu√° tr√¨nh handshake...');
                const handshakeBtn = document.getElementById('handshakeBtn');
                handshakeBtn.disabled = true;

                const response = await fetch(`${API_URL}/api/handshake`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: 'Hello!' })
                });

                const data = await response.json();

                if (response.ok && data.message === 'Ready!') {
                    sessionId = data.sessionId;
                    publicKey = data.publicKey;
                    log(`Handshake th√†nh c√¥ng! SessionID: ${sessionId}`);
                    updateStatus('Handshake ho√†n th√†nh, s·∫µn s√†ng g·ª≠i file');
                    document.getElementById('uploadBtn').disabled = false;
                } else {
                    throw new Error(data.error || 'Handshake th·∫•t b·∫°i');
                }
            } catch (error) {
                log(`L·ªói handshake: ${error.message}`);
                updateStatus('L·ªói handshake');
                document.getElementById('handshakeBtn').disabled = false;
            }
        }

        // Handle file upload
        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const fileInput = document.getElementById('fileInput');
            const expirationInput = document.getElementById('expirationInput');
            const uploadBtn = document.getElementById('uploadBtn');

            if (!sessionId) {
                log('L·ªói: Vui l√≤ng th·ª±c hi·ªán handshake tr∆∞·ªõc');
                return;
            }

            if (!fileInput.files[0]) {
                log('L·ªói: Vui l√≤ng ch·ªçn m·ªôt file vƒÉn b·∫£n (.txt)');
                return;
            }

            const file = fileInput.files[0];
            if (!file.name.endsWith('.txt')) {
                log('L·ªói: Ch·ªâ ch·∫•p nh·∫≠n file c√≥ ƒë·ªãnh d·∫°ng .txt');
                return;
            }

            const expirationHours = parseInt(expirationInput.value) || 24;
            const expirationDate = new Date(Date.now() + expirationHours * 60 * 60 * 1000).toISOString();

            const formData = new FormData();
            formData.append('file', file);
            formData.append('sessionId', sessionId);
            formData.append('filename', file.name);
            formData.append('expiration', expirationDate);

            try {
                uploadBtn.disabled = true;
                log(`ƒêang m√£ h√≥a v√† g·ª≠i file ${file.name}...`);

                const response = await fetch(`${API_URL}/api/send-file`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (response.ok) {
                    log(`File ${file.name} g·ª≠i th√†nh c√¥ng! FileID: ${data.fileId}`);
                    updateStatus(`File ${file.name} ƒë√£ ƒë∆∞·ª£c m√£ h√≥a v√† g·ª≠i`);
                    fileInput.value = ''; // Reset file input
                } else {
                    throw new Error(data.error || 'G·ª≠i file th·∫•t b·∫°i');
                }
            } catch (error) {
                log(`L·ªói g·ª≠i file: ${error.message}`);
                updateStatus('L·ªói g·ª≠i file');
            } finally {
                uploadBtn.disabled = false;
            }
        });

        // Initialize
        updateStatus('S·∫µn s√†ng ƒë·ªÉ b·∫Øt tay');
        log('H·ªá th·ªëng kh·ªüi t·∫°o th√†nh c√¥ng');
    </script>
</body>
</html>